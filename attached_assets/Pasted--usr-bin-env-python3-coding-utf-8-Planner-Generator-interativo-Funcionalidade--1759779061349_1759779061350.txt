#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Planner/Generator interativo ‚Äî Funcionalidade: BRIGADA (compat√≠vel com o seu projeto)
- Controllers em src/controllers/
- Sem namespaces; rotas em public/index.php
- Sem Models; usa $this->db (PDO-like) dentro do Controller
- Views inclu√≠das diretamente
- RBAC via snippet configur√°vel
- Tabela de profissionais: profissionais_renner
- N√ÉO executa nada sem sua permiss√£o; gera rascunhos primeiro
"""

import os, sys, shutil
from textwrap import dedent

DEFAULTS = {
    "app_root": "./",
    "controllers_dir": "src/controllers",
    "views_dir": "views",  # geraremos views/brigada/index.php
    "routes_file": "public/index.php",
    "menu_file": "views/partials/sidebar.php",   # ajuste se seu menu estiver em outro local
    "db_name": "controle-portaria-db",
    "db_schema": "public",
    "professionals_table": "profissionais_renner",
    # Snippet de RBAC: edite este c√≥digo para seu mecanismo real (p.ex. requirePermission, checkRole etc.)
    "rbac_check_php": "if (!function_exists('requirePermission') || !requirePermission('brigada.manage')) { http_response_code(403); echo 'Acesso negado'; exit; }"
}

BANNER = r"""
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
      PLANEJADOR ‚Äî M√ìDULO "BRIGADA" (vers√£o compat√≠vel)
"""

PLAN = [
    ("M1", "Validar estrutura (controllers/views/rotas/menu) e vari√°veis."),
    ("M2", "Gerar MIGRATION SQL (tabela public.brigadistas ‚Üí FK profissionais_renner)."),
    ("M3", "Gerar Controller: src/controllers/BrigadaController.php (usa $this->db)."),
    ("M4", "Gerar VIEW: views/brigada/index.php (buscar profissional ‚Üí incluir ‚Üí listar/ remover)."),
    ("M5", "Gerar SNIPPETS: Rotas (public/index.php) e Menu (sidebar)."),
    ("M6", "Aplicar (copiar) rascunhos para o projeto (opcional)."),
    ("M7", "Checklist de testes e seguran√ßa (CSRF, RBAC, unaccent, auditoria)."),
    ("M8", "Orienta√ß√µes de deploy (rodar SQL, limpar cache/opcache, smoke test)."),
]

def ask_yes_no(q):
    while True:
        a = input(f"{q} [s/N]: ").strip().lower()
        if a in ("s","sim","y","yes"): return True
        if a in ("n","nao","n√£o","no",""): return False

def ensure_dir(p): os.makedirs(p, exist_ok=True)

def write_file(path, content, overwrite=False):
    ensure_dir(os.path.dirname(path))
    if os.path.exists(path) and not overwrite:
        print(f"‚ö†Ô∏è  J√° existe: {path} ‚Äî n√£o sobrescrito.")
        return
    with open(path, "w", encoding="utf-8") as f: f.write(content)
    print(f"‚úÖ Gerado: {path}")

def safe_copy(src, dst):
    ensure_dir(os.path.dirname(dst))
    shutil.copy2(src, dst)
    print(f"‚û°Ô∏è  Copiado: {src} ‚Üí {dst}")

def migration_sql(cfg):
    s = cfg["db_schema"]; prof = cfg["professionals_table"]
    return dedent(f"""
    -- MIGRATION: Tabela de Brigadistas (compat√≠vel com seu schema atual)
    CREATE TABLE IF NOT EXISTS {s}.brigadistas (
      id              BIGSERIAL PRIMARY KEY,
      professional_id BIGINT NOT NULL UNIQUE,
      active          BOOLEAN NOT NULL DEFAULT TRUE,
      note            TEXT,
      created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
      CONSTRAINT fk_brigadista_prof FOREIGN KEY (professional_id)
        REFERENCES {s}.{prof}(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_brigadistas_active ON {s}.brigadistas(active);

    -- Trigger updated_at
    CREATE OR REPLACE FUNCTION {s}.set_updated_at() RETURNS trigger AS $$
    BEGIN NEW.updated_at := now(); RETURN NEW; END;
    $$ LANGUAGE plpgsql;

    DROP TRIGGER IF EXISTS trg_brigadistas_updated_at ON {s}.brigadistas;
    CREATE TRIGGER trg_brigadistas_updated_at
      BEFORE UPDATE ON {s}.brigadistas
      FOR EACH ROW EXECUTE FUNCTION {s}.set_updated_at();

    -- Opcional: para busca ignorando acentos
    CREATE EXTENSION IF NOT EXISTS unaccent;
    """).strip()+"\n"

def controller_php(cfg):
    s = cfg["db_schema"]; prof = cfg["professionals_table"]; rbac = cfg["rbac_check_php"]
    return dedent(f"""\
    <?php
    // src/controllers/BrigadaController.php
    // Sem namespaces. Usa $this->db (PDO-like). Views inclu√≠das diretamente.

    class BrigadaController {{
        private $db;

        public function __construct($db) {{
            $this->db = $db;
        }}

        private function guard() {{
            {rbac}
        }}

        public function index() {{
            $this->guard();
            $stmt = $this->db->query("SELECT b.id, b.professional_id, b.active, p.name AS professional_name, p.sector
                                       FROM {s}.brigadistas b
                                       JOIN {s}.{prof} p ON p.id = b.professional_id
                                       ORDER BY p.name ASC");
            $brigadistas = $stmt->fetchAll(PDO::FETCH_ASSOC);
            $pageTitle = 'Brigada';
            include __DIR__ . '/../../views/brigada/index.php';
        }}

        public function apiSearchProfessionals() {{
            $this->guard();
            $q = isset($_GET['q']) ? trim($_GET['q']) : '';
            header('Content-Type: application/json; charset=utf-8');
            if (mb_strlen($q) < 2) {{ echo json_encode([]); return; }}

            $sql = "SELECT id, name, sector
                    FROM {s}.{prof}
                    WHERE unaccent(name) ILIKE unaccent(:q)
                    ORDER BY name ASC
                    LIMIT 20";
            $st = $this->db->prepare($sql);
            $st->execute([':q' => "%{{$q}}%"]);
            echo json_encode($st->fetchAll(PDO::FETCH_ASSOC));
        }}

        public function add() {{
            $this->guard();
            // TODO: validar/usar seu CSRF padr√£o
            $pid = isset($_POST['professional_id']) ? (int)$_POST['professional_id'] : 0;
            if ($pid > 0) {{
                $sql = "INSERT INTO {s}.brigadistas(professional_id) VALUES(:pid)
                        ON CONFLICT (professional_id) DO UPDATE SET active=TRUE, updated_at=now()
                        RETURNING id";
                $st = $this->db->prepare($sql);
                $st->execute([':pid' => $pid]);
            }}
            header('Location: /brigada'); exit;
        }}

        public function remove() {{
            $this->guard();
            // TODO: validar/usar seu CSRF padr√£o
            $id = isset($_POST['id']) ? (int)$_POST['id'] : 0;
            if ($id > 0) {{
                $st = $this->db->prepare("DELETE FROM {s}.brigadistas WHERE id=:id");
                $st->execute([':id' => $id]);
            }}
            header('Location: /brigada'); exit;
        }}
    }}
    """).strip()+"\n"

def view_php():
    return dedent("""\
    <!-- views/brigada/index.php -->
    <div class="content-header">
      <div class="container-fluid">
        <h1 class="m-0">Brigada</h1>
        <p class="text-muted">Inclua brigadistas a partir dos profissionais j√° cadastrados e visualize a lista atual.</p>
      </div>
    </div>

    <section class="content">
      <div class="container-fluid">

        <!-- Incluir brigadista -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">Incluir brigadista</h3></div>
          <div class="card-body">
            <div class="form-group">
              <label for="q">Buscar profissional</label>
              <input type="text" id="q" class="form-control" placeholder="Digite o nome..." />
            </div>
            <div id="searchResults" class="list-group mb-3" style="display:none;"></div>

            <form id="formAdd" method="POST" action="/brigada/add" style="display:none;">
              <!-- TODO: inclua seu token CSRF -->
              <input type="hidden" name="professional_id" id="professional_id" />
              <button type="submit" class="btn btn-primary">Adicionar √† Brigada</button>
            </form>
          </div>
        </div>

        <!-- Lista -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">Brigadistas</h3></div>
          <div class="card-body p-0">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Profissional</th>
                  <th>Setor</th>
                  <th>Status</th>
                  <th style="width:110px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <?php foreach (($brigadistas ?? []) as $b): ?>
                <tr>
                  <td><?= htmlspecialchars($b['professional_name']) ?></td>
                  <td><?= htmlspecialchars($b['sector'] ?? '-') ?></td>
                  <td><?= !empty($b['active']) ? 'Ativo' : 'Inativo' ?></td>
                  <td>
                    <form method="POST" action="/brigada/remove" onsubmit="return confirm('Remover brigadista?');">
                      <!-- TODO: inclua seu token CSRF -->
                      <input type="hidden" name="id" value="<?= (int)$b['id'] ?>">
                      <button class="btn btn-sm btn-danger">Remover</button>
                    </form>
                  </td>
                </tr>
                <?php endforeach; ?>
                <?php if (empty($brigadistas)): ?>
                <tr><td colspan="4" class="text-center text-muted">Nenhum brigadista cadastrado.</td></tr>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <script>
    // Busca din√¢mica com debounce
    const q = document.getElementById('q');
    const results = document.getElementById('searchResults');
    const formAdd = document.getElementById('formAdd');
    const pidInput = document.getElementById('professional_id');
    let timer;

    q.addEventListener('input', () => {
      const t = q.value.trim();
      clearTimeout(timer);
      if (t.length < 2) { results.style.display='none'; return; }

      timer = setTimeout(async () => {
        const resp = await fetch('/api/professionals/search?q=' + encodeURIComponent(t));
        if (!resp.ok) return;
        const data = await resp.json();
        results.innerHTML = '';
        data.forEach(p => {
          const a = document.createElement('a');
          a.href = '#'; a.className = 'list-group-item list-group-item-action';
          a.textContent = `${p.name} ‚Äî ${p.sector || '-'}`;
          a.onclick = (e) => {
            e.preventDefault();
            pidInput.value = p.id;
            formAdd.style.display = 'block';
            results.style.display = 'none';
            q.value = p.name;
          };
          results.appendChild(a);
        });
        results.style.display = data.length ? 'block' : 'none';
      }, 300);
    });
    </script>
    """).strip()+"\n"

def routes_snippet():
    # Snippet amig√°vel para roteador simples em public/index.php
    return dedent("""\
    <?php
    // === ROTAS BRIGADA (cole abaixo do bootstrap do seu app em public/index.php) ===
    $uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
    $method = $_SERVER['REQUEST_METHOD'];

    // Certifique-se de ter sua $db e seu mecanismo de sess√£o/permiss√µes inicializados antes

    if ($uri === '/brigada' && $method === 'GET') {
        require_once __DIR__ . '/../src/controllers/BrigadaController.php';
        (new BrigadaController($db))->index(); exit;
    }

    if ($uri === '/api/professionals/search' && $method === 'GET') {
        require_once __DIR__ . '/../src/controllers/BrigadaController.php';
        (new BrigadaController($db))->apiSearchProfessionals(); exit;
    }

    if ($uri === '/brigada/add' && $method === 'POST') {
        require_once __DIR__ . '/../src/controllers/BrigadaController.php';
        (new BrigadaController($db))->add(); exit;
    }

    if ($uri === '/brigada/remove' && $method === 'POST') {
        require_once __DIR__ . '/../src/controllers/BrigadaController.php';
        (new BrigadaController($db))->remove(); exit;
    }
    // === FIM ROTAS BRIGADA ===
    """).strip()+"\n"

def menu_snippet():
    return dedent("""\
    <!-- ITEM DE MENU "BRIGADA" -->
    <li class="nav-item">
      <a href="/brigada" class="nav-link">
        <i class="nav-icon fas fa-fire-extinguisher"></i>
        <p>Brigada</p>
      </a>
    </li>
    """).strip()+"\n"

def main():
    print(BANNER)
    print("Objetivo: BRIGADA ‚Üí incluir brigadista a partir de profissionais (profissionais_renner) e listar na mesma tela.\n")
    print("üìå PLANO")
    for code, desc in PLAN: print(f"  {code} ‚Äî {desc}")
    print()

    cfg = DEFAULTS.copy()
    print("üìÅ Caminhos/ajustes assumidos:")
    for k,v in cfg.items(): print(f"  - {k}: {v}")
    print("\nEdite DEFAULTS no topo do script se precisar ajustar algo.\n")

    # Drafts
    ensure_dir("feature_brigada/drafts/migrations")
    ensure_dir("feature_brigada/drafts/controllers")
    ensure_dir("feature_brigada/drafts/views")
    ensure_dir("feature_brigada/drafts/snippets")

    if ask_yes_no("M2) Gerar rascunho da MIGRATION SQL?"):
        write_file("feature_brigada/drafts/migrations/001_create_brigadistas.sql", migration_sql(cfg))

    if ask_yes_no("M3) Gerar rascunho do Controller (src/controllers/BrigadaController.php)?"):
        write_file("feature_brigada/drafts/controllers/BrigadaController.php", controller_php(cfg))

    if ask_yes_no("M4) Gerar rascunho da VIEW (views/brigada/index.php)?"):
        write_file("feature_brigada/drafts/views/index.php", view_php())

    if ask_yes_no("M5) Gerar rascunhos de SNIPPETS (rotas + menu)?"):
        write_file("feature_brigada/drafts/snippets/routes_brigada.php", routes_snippet())
        write_file("feature_brigada/drafts/snippets/menu_brigada.html", menu_snippet())

    print("\nüß™ M7) Checklist (somente instru√ß√µes):")
    print(dedent(f"""
    - RBAC: ajuste o snippet em DEFAULTS['rbac_check_php'] para seu mecanismo real.
    - CSRF: inclua seu token nos forms POST (/brigada/add, /brigada/remove).
    - Postgres: garanta a extens√£o unaccent ativa e a tabela {cfg['professionals_table']}.
    - Auditoria/LGPD: se usa triggers, adicione-as tamb√©m a public.brigadistas.
    """))

    if ask_yes_no("\nM6) Aplicar (copiar) rascunhos para o projeto agora?"):
        dst_controller = os.path.join(cfg["controllers_dir"], "BrigadaController.php")
        dst_view_dir = os.path.join(cfg["views_dir"], "brigada")
        dst_view = os.path.join(dst_view_dir, "index.php")
        ensure_dir(dst_view_dir)

        safe_copy("feature_brigada/drafts/controllers/BrigadaController.php", dst_controller)
        safe_copy("feature_brigada/drafts/views/index.php", dst_view)
        print("\nüëâ A√ß√µes manuais:")
        print(f"  1) Rotas ‚Üí edite {cfg['routes_file']} e cole feature_brigada/drafts/snippets/routes_brigada.php")
        print(f"  2) Menu  ‚Üí edite {cfg['menu_file']} e cole feature_brigada/drafts/snippets/menu_brigada.html")
        print( "  3) SQL   ‚Üí psql -d controle-portaria-db -f feature_brigada/drafts/migrations/001_create_brigadistas.sql")
        print( "  4) Limpar cache/opcache (se aplic√°vel) e testar /brigada.")

    print("\nüéâ Pronto. Nada foi executado sem permiss√£o. Rascunhos em feature_brigada/.\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nInterrompido pelo usu√°rio.")
        sys.exit(1)

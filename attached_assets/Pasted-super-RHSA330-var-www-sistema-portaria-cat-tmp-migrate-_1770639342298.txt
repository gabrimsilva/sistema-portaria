super@RHSA330:/var/www/sistema-portaria$ cat > /tmp/migrate_fix.php << 'EOF'
<?php
echo "=== Migração v2.0 ===\n\n";

$config = require '/var/www/sistema-portaria/config/database.local.php';
$dsn = "pgsql:host={$config['host']};port={$config['port']};dbname={$config['database']}";

try {
    $pdo = new PDO($dsn, $config['username'], $config['password'], [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
    echo "[OK] Conectado ao banco\n\n";
} catch (PDOException $e) {
    die("ERRO: " . $e->getMessage() . "\n");
}

$sqls = [
    "CREATE TABLE IF NOT EXISTS roles (id SERIAL PRIMARY KEY, name VARCHAR(100) NOT NULL UNIQUE, description TEXT, system_role BOOLEAN DEFAULT false, active BOOLEAN DEFAULT true, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS organization_settings (id SERIAL PRIMARY KEY, nome_empresa VARCHAR(255) DEFAULT 'Sistema de Controle de Acesso', logo_path VARCHAR(255), cor_primaria VARCHAR(20) DEFAULT '#0d6efd', cor_secundaria VARCHAR(20) DEFAULT '#6c757d', data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS usuarios (id SERIAL PRIMARY KEY, nome VARCHAR(255) NOT NULL, email VARCHAR(255) UNIQUE NOT NULL, senha_hash VARCHAR(255) NOT NULL, perfil VARCHAR(50) DEFAULT 'operador', ativo BOOLEAN DEFAULT true, data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP, ultimo_login TIMESTAMP, role_id INTEGER, anonymized_at TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS profissionais_renner (id SERIAL PRIMARY KEY, nome VARCHAR(255) NOT NULL, cpf VARCHAR(14), cargo VARCHAR(100), setor VARCHAR(100), foto VARCHAR(255), ativo BOOLEAN DEFAULT true, data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP, brigadista BOOLEAN DEFAULT false)",
    "CREATE TABLE IF NOT EXISTS registro_acesso (id SERIAL PRIMARY KEY, profissional_renner_id INTEGER REFERENCES profissionais_renner(id), data_entrada TIMESTAMP DEFAULT CURRENT_TIMESTAMP, data_saida TIMESTAMP, placa_veiculo VARCHAR(20), observacao TEXT, justificativa_retroativa TEXT, registrado_por INTEGER REFERENCES usuarios(id))",
    "CREATE TABLE IF NOT EXISTS visitantes_cadastro (id SERIAL PRIMARY KEY, nome VARCHAR(255) NOT NULL, tipo_documento VARCHAR(50), numero_documento VARCHAR(50), pais_documento VARCHAR(100), empresa VARCHAR(255), foto VARCHAR(255), data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP, validade_ate DATE, ativo BOOLEAN DEFAULT true)",
    "CREATE TABLE IF NOT EXISTS visitantes_registros (id SERIAL PRIMARY KEY, visitante_cadastro_id INTEGER REFERENCES visitantes_cadastro(id), data_entrada TIMESTAMP DEFAULT CURRENT_TIMESTAMP, data_saida TIMESTAMP, motivo TEXT, setor_destino VARCHAR(100), pessoa_contato VARCHAR(255), cracha VARCHAR(50), observacao TEXT, registrado_por INTEGER REFERENCES usuarios(id))",
    "CREATE TABLE IF NOT EXISTS prestadores_cadastro (id SERIAL PRIMARY KEY, nome VARCHAR(255) NOT NULL, tipo_documento VARCHAR(50), numero_documento VARCHAR(50), pais_documento VARCHAR(100), empresa VARCHAR(255), foto VARCHAR(255), data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP, validade_ate DATE, ativo BOOLEAN DEFAULT true)",
    "CREATE TABLE IF NOT EXISTS prestadores_registros (id SERIAL PRIMARY KEY, prestador_cadastro_id INTEGER REFERENCES prestadores_cadastro(id), data_entrada TIMESTAMP DEFAULT CURRENT_TIMESTAMP, data_saida TIMESTAMP, motivo TEXT, setor_destino VARCHAR(100), pessoa_contato VARCHAR(255), cracha VARCHAR(50), observacao TEXT, registrado_por INTEGER REFERENCES usuarios(id))",
    "CREATE TABLE IF NOT EXISTS ramais (id SERIAL PRIMARY KEY, nome VARCHAR(255) NOT NULL, area VARCHAR(255), ramal_celular VARCHAR(50), tipo VARCHAR(20) DEFAULT 'interno', observacoes TEXT, ativo BOOLEAN DEFAULT true, data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS sites (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, address TEXT, capacity INTEGER, timezone VARCHAR(100) DEFAULT 'America/Sao_Paulo', active BOOLEAN DEFAULT true, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS sectors (id SERIAL PRIMARY KEY, site_id INTEGER REFERENCES sites(id), name VARCHAR(255) NOT NULL, capacity INTEGER, active BOOLEAN DEFAULT true, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS holidays (id SERIAL PRIMARY KEY, date DATE NOT NULL, name VARCHAR(255) NOT NULL, scope VARCHAR(50) DEFAULT 'global', site_id INTEGER REFERENCES sites(id), active BOOLEAN DEFAULT true, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS permissions (id SERIAL PRIMARY KEY, key VARCHAR(100) NOT NULL UNIQUE, description TEXT, module VARCHAR(100), created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)",
    "CREATE TABLE IF NOT EXISTS role_permissions (id SERIAL PRIMARY KEY, role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE, permission_id INTEGER REFERENCES permissions(id) ON DELEOFo "\nFinalizado!\n";iado\n";arios (nome,email,senha_hash,perfil,ativo,role_id) VALUES ('Administrador','admin@sistema.com','$h','administrador',true,1)");RE role_id=1) ON CONFLICT D
super@RHSA330:/var/www/sistema-portaria$ sudo php /tmp/migrate_fix.php
=== Migração v2.0 ===

[OK] Conectado ao banco

[OK] Tabela 1
[OK] Tabela 2
[OK] Tabela 3
[OK] Tabela 4
[OK] Tabela 5
[OK] Tabela 6
[OK] Tabela 7
[OK] Tabela 8
[OK] Tabela 9
[OK] Tabela 10
[OK] Tabela 11
[OK] Tabela 12
[OK] Tabela 13
[OK] Tabela 14
[OK] Tabela 15
[OK] Tabela 16
[OK] Tabela 17
[OK] Roles
[OK] Permissões
[OK] Admin com todas permissões

Finalizado!
super@RHSA330:/var/www/sistema-portaria$ sudo systemctl restart apache2
super@RHSA330:/var/www/sistema-portaria$ 
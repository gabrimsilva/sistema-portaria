Prompt — Reformular Relatórios > Visitantes (analisar → propor → executar sob confirmação)

Contexto do produto: Sistema de controle de entrada/saída.
Tela-alvo: Relatórios → Visitantes.
Objetivo desta tarefa:

Exibir todos os cadastros do dia (padrão: hoje) dos visitantes que entraram.

Implementar filtros por data, setor, status, empresa e funcionário responsável.

Na lista, exibir os campos: Nome completo, Setor, Placa de veículo / “A pé”, Empresa, Funcionário responsável, CPF e Data/Hora de entrada.

Remover da tela a opção de incluir/cadastrar visitante (sem botão/atalho).

Trabalhar em 3 fases: Análise → Proposta (com diffs) → Execução. Antes de executar, pergunte se pode executar e aguarde minha resposta “executa” ou “não”.

Regras e detalhes de negócio

“Visitantes” = registros com tipo = VISITANTE (ou o equivalente já usado).

Status:

Em aberto = saida_at IS NULL.

Finalizado = saida_at IS NOT NULL.

Todos = ambos.

Filtro de data: por data única (YYYY-MM-DD). Se suportar intervalo, aceitar data_ini/data_fim (opcional). Padrão: hoje (fuso do sistema, ex.: America/Sao_Paulo).

Placa / “A pé”: se placa vazia/nula, renderizar “A pé”; senão, mostrar placa em maiúsculas.

CPF: exibir mascarado ***.***.***-** (revelar só se o usuário tiver permissão).

Paginação: padrão 20 por página; aceitar page e pageSize.

Ordenação: padrão por entrada_at DESC.

Remover inclusão: ocultar/remover apenas nesta tela o botão/modal de “Cadastrar Visitante” (não quebrar outras telas).

FASE A — ANÁLISE (somente leitura, não alterar nada)

Identificar modelo de dados (tabelas/campos) para visitantes e registros de acesso.

Localizar rotas/serviços já existentes que listam registros.

Encontrar o botão/atalho de “Cadastrar Visitante” nesta página para ocultar/remover.

Verificar índices úteis: tipo, entrada_at, setor, empresa, responsavel_id, saida_at.

Gerar RELATORIO_VISITANTES_ANALISE.md com:

Resumo de arquitetura (back/front).

Tabela OK / FALTA / INCOMPLETO para filtros, colunas, paginação, remoção do botão, índices e mascaramento de CPF.

Saída esperada agora: imprimir no console e salvar o RELATORIO_VISITANTES_ANALISE.md.

FASE B — PROPOSTA (plano completo + diffs, ainda sem aplicar)
Back-end

Nova rota (ou ajuste) do relatório:
GET /relatorios/visitantes?data=YYYY-MM-DD&setor=...&status=aberto|finalizado|todos&empresa=...&responsavel_id=...&page=1&pageSize=20
(Opcional: data_ini, data_fim para intervalo.)

Consulta (Prisma/SQL) com filtros combináveis:

tipo = VISITANTE

Data: DATE(entrada_at) = :data ou entrada_at BETWEEN :ini AND :fim

setor se enviado

empresa (igual ou ilike, conforme padrão do projeto)

responsavel_id se enviado

Status conforme saida_at

Transformações na resposta:

placa_ou_ape: se placa nula/vazia → "A pé"; senão, placa.toUpperCase().

cpf_mascarado: retornar ***.***.***-** (só revelar com permissão RBAC).

Resposta JSON (exemplo):

{
  "items": [
    {
      "nome_completo": "Fulano da Silva",
      "setor": "Comercial",
      "placa_ou_ape": "ABC1D23",
      "empresa": "Cliente XYZ",
      "responsavel": "Maria Souza",
      "cpf": "***.***.***-**",
      "entrada_at": "2025-09-24T09:14:00-03:00",
      "status": "aberto"
    }
  ],
  "page": 1,
  "pageSize": 20,
  "total": 128
}


Índices recomendados (se faltarem):

CREATE INDEX idx_registros_tipo_entrada ON registros (tipo, entrada_at DESC);

CREATE INDEX idx_registros_setor ON registros (setor);

CREATE INDEX idx_registros_empresa ON registros (empresa);

CREATE INDEX idx_registros_responsavel ON registros (responsavel_id);

CREATE INDEX idx_registros_status ON registros (saida_at);

Testes (unit/integration):

Combinações de filtros (data+setor+status+empresa+responsavel).

Ordenação e paginação.

Máscara de CPF aplicada para perfis sem permissão.

Front-end

Página Relatórios → Visitantes com:

Filtros:

Data (ou intervalo: data_ini/data_fim)

Setor (dropdown)

Status (Todos/Em aberto/Finalizado)

Empresa (input ou dropdown com autocomplete)

Funcionário responsável (autocomplete por colaborador ou dropdown)

Tabela com colunas na ordem: Nome completo, Setor, Placa/A pé, Empresa, Funcionário responsável, CPF (mascarado), Data/Hora de entrada.

Paginação (page/pageSize) e total.

Remover/ocultar o botão “Cadastrar Visitante” nesta página.

Estado vazio: “Nenhum registro encontrado para os filtros selecionados.”

(Opcional) Exportar CSV do resultado atual.

Acessibilidade/UX:

Placeholders claros, loading/spinner, mensagens de erro amigáveis.

Entregáveis da Fase B

Arquivo PLANO_REL_VISITANTES.md contendo:

Plano detalhado (back e front).

Diffs em blocos ```diff com as mudanças nos arquivos.

SQL/migrações de índices (se necessárias).

Comandos planejados (ex.: npm run migrate, npm run test).

Critérios de aceite e checklist de testes manuais.

Importante: Nesta fase NÃO aplicar nada. Apenas mostrar o que será feito.

FASE C — EXECUÇÃO (somente com minha autorização)

Pergunte explicitamente:
“Posso executar as alterações de Relatórios → Visitantes? Responda executa para prosseguir ou não para cancelar.”

Se eu responder executa:

Criar branch feat/relatorio-visitantes.

Aplicar os diffs (back e front).

Executar migrações/SQL de índices (se houver).

Rodar testes e imprimir resultados.

Mostrar resumo dos arquivos alterados e endpoints criados/ajustados.

Se eu responder não: não aplicar nada; manter apenas análise e plano.

Critérios de Aceite (QA)

Ao abrir a tela, listar entradas de hoje (visitantes) com nome, setor, placa/“A pé”, empresa, responsável, CPF (mascarado) e data/hora de entrada.

Filtros por data, setor, status, empresa e responsável funcionando e combináveis.

Paginação e ordem por entrada_at DESC.

Nenhuma opção de incluir/cadastrar visitante na tela.

CPF sempre mascarado para perfis sem permissão; revelar apenas mediante RBAC.

Performance: consulta por data retorna em < 300 ms com os índices aplicados.

Testes cobrindo filtros, paginação e mascaramento de CPF.

Formato de resposta esperado AGORA

Resumo da análise.

RELATORIO_VISITANTES_ANALISE.md (conteúdo).

PLANO_REL_VISITANTES.md com diffs/SQL/comandos.

A pergunta: “Posso executar? (executa / não)”.

Reforço: não executar nada até eu responder executa.
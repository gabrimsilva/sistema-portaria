Prompt — Relatórios > Prestadores de Serviços (analisar → propor → executar sob confirmação, com limpeza de “sujeiras” entre telas)

Contexto do produto: Sistema de controle de entrada/saída.
Tela-alvo: Relatórios → Prestadores de Serviços.
Objetivo desta tarefa:

Listar todos os cadastros do dia (padrão: hoje) dos prestadores de serviços que entraram.

Implementar filtros por data, setor, status, empresa e funcionário responsável.

Na lista, exibir: Nome completo, Setor, Placa de veículo / “A pé”, Empresa, Funcionário responsável, CPF (mascarado) e Data/Hora de entrada.

Remover desta tela a opção de incluir/cadastrar prestador.

Garantir limpeza de “sujeiras” (estado/efeitos/requests) ao navegar entre telas de relatório, evitando que um estado interfira no outro.

Regras e detalhes de negócio

“Prestadores de serviços” = registros com tipo = PRESTADOR (ou equivalente no projeto).

Status:

Em aberto = saida_at IS NULL

Finalizado = saida_at IS NOT NULL

Todos = ambos

Filtro de data: por data única (YYYY-MM-DD). Se houver, aceitar intervalo data_ini/data_fim. Padrão = hoje (fuso, ex.: America/Sao_Paulo).

Placa / “A pé”: se placa vazia/nula → exibir “A pé”; senão, placa.toUpperCase().

CPF: exibir mascarado ***.***.***-** para perfis sem permissão (RBAC).

Paginação: padrão 20 por página; suportar page e pageSize.

Ordenação: padrão por entrada_at DESC.

Remover inclusão: ocultar/remover apenas nesta tela o botão/modal “Cadastrar Prestador”.

FASE A — ANÁLISE (somente leitura, não alterar nada)

Mapear modelo de dados (tabelas/campos) para prestadores e registros.

Localizar rotas/serviços existentes que listam registros e o botão/atalho de cadastro de prestador nesta tela (para remover).

Verificar índices: tipo, entrada_at, setor, empresa, responsavel_id, saida_at.

Auditar front: identificar pontos que podem causar sujeira entre telas (ex.: filtros persistindo indevidamente, requests pendentes, modais abertos, listeners globais, debounce/intervalos não limpos, estilos vazando).

Gerar RELATORIO_PRESTADORES_ANALISE.md com:

Resumo de arquitetura (back/front).

Tabela OK / FALTA / INCOMPLETO para filtros/colunas/paginação/remoção do botão/índices/máscara de CPF.

Lista de riscos de “sujeira” detectados por tela e componente.

Saída esperada agora: imprimir no console e salvar RELATORIO_PRESTADORES_ANALISE.md.

FASE B — PROPOSTA (plano completo + diffs, ainda sem aplicar)
Back-end

Nova rota (ou ajuste) de relatório:
GET /relatorios/prestadores?data=YYYY-MM-DD&setor=...&status=aberto|finalizado|todos&empresa=...&responsavel_id=...&page=1&pageSize=20
(Opcional: suporte a data_ini/data_fim.)

Consulta (Prisma/SQL) com filtros combináveis:

tipo = PRESTADOR

Data: DATE(entrada_at) = :data ou entrada_at BETWEEN :ini AND :fim

setor (igual/ilike, conforme padrão do projeto)

empresa (igual/ilike)

responsavel_id

Status por saida_at

Transformações na resposta:

placa_ou_ape: "A pé" se vazio; senão, placa em maiúsculas.

cpf: retornado mascarado ***.***.***-**, salvo se permissão para ver íntegro.

Resposta JSON: { items, page, pageSize, total } com campos solicitados.

Índices recomendados (se faltarem):

CREATE INDEX idx_reg_tipo_entrada ON registros (tipo, entrada_at DESC);

CREATE INDEX idx_reg_setor ON registros (setor);

CREATE INDEX idx_reg_empresa ON registros (empresa);

CREATE INDEX idx_reg_responsavel ON registros (responsavel_id);

CREATE INDEX idx_reg_status ON registros (saida_at);

Testes: unit/integration para filtros combinados, ordenação, paginação e RBAC de CPF.

Front-end

Página Relatórios → Prestadores com:

Filtros: Data (ou intervalo), Setor (dropdown), Status (Todos/Em aberto/Finalizado), Empresa (input/autocomplete), Funcionário responsável (autocomplete/seleção).

Tabela com colunas: Nome completo, Setor, Placa/A pé, Empresa, Funcionário responsável, CPF (mascarado), Data/Hora de entrada.

Paginação e total.

Remover/ocultar o botão “Cadastrar Prestador” nesta página.

Estado vazio: “Nenhum registro encontrado para os filtros selecionados.”

(Opcional) Exportar CSV do resultado atual.

Limpeza de “sujeiras” entre telas (higiene de estado/efeitos)

Em cada tela de relatório (Profissionais, Visitantes, Prestadores):

Abortar fetches pendentes ao desmontar (AbortController ou cancel token).

Limpar timers (setInterval/setTimeout) e debounces no cleanup do useEffect.

Desinscrever listeners/event-bus ao desmontar.

Resetar filtros ao sair da rota (ou isolar o estado por rota usando chaves/escopos distintos, p.ex. useRelatorioStore('prestadores')).

Chaves de cache únicas por tela (React Query/ SWR) para evitar reuso indevido.

Fechar modais/toasts no unmount.

Evitar vazamento de estilos (CSS Modules/Tailwind; ids únicos).

Limpar localStorage/sessionStorage de chaves temporárias específicas da tela no unmount.

Navegação cruzada QA: alternar rapidamente entre as três telas sem erros, sem filtros “fantasma”, sem requisições correndo atrás da rota.

Entregáveis da Fase B

Arquivo PLANO_REL_PRESTADORES.md contendo:

Plano detalhado (back e front).

Diffs em blocos ```diff com os arquivos a criar/alterar.

SQL/migrações para índices (se necessário).

Comandos planejados (ex.: npm run migrate, npm run test).

Checklist de higiene (itens de limpeza implementados).

Critérios de aceite e roteiro de testes manuais (incluindo navegação entre telas).

Importante: Nesta fase NÃO aplicar nada. Apenas mostrar o que será feito.

FASE C — EXECUÇÃO (somente com minha autorização)

Pergunte explicitamente:
“Posso executar as alterações de Relatórios → Prestadores de Serviços? Responda executa para prosseguir ou não para cancelar.”

Se eu responder executa:

Criar branch feat/relatorio-prestadores.

Aplicar os diffs (back e front).

Executar migrações/SQL de índices (se houver).

Rodar testes e imprimir resultados.

Mostrar resumo dos arquivos alterados e endpoints novos/ajustados.

Se eu responder não: não aplicar nada; manter apenas análise e plano.

Critérios de Aceite (QA)

Ao abrir a tela, listar entradas de hoje (prestadores) com nome, setor, placa/“A pé”, empresa, responsável, CPF (mascarado), data/hora de entrada.

Filtros por data, setor, status, empresa e responsável funcionando e combináveis.

Paginação e ordem por entrada_at DESC.

Nenhuma opção de incluir/cadastrar prestador na tela.

CPF mascarado para perfis sem permissão; revelar apenas via RBAC.

Performance: consulta por data retorna em < 300 ms com índices aplicados.

Higiene entre telas: navegar entre Profissionais/Visitantes/Prestadores sem vazamento de estado, sem requests pendentes, sem filtros indevidos, sem erros no console.

Testes cobrindo filtros, paginação, RBAC de CPF e navegação cruzada.

Formato de resposta esperado AGORA

Resumo da análise.

RELATORIO_PRESTADORES_ANALISE.md (conteúdo).

PLANO_REL_PRESTADORES.md com diffs/SQL/comandos/checklist de higiene.

A pergunta: “Posso executar? (executa / não)”.

Reforço: não executar nada até eu responder executa.
PROMPT (cole no Replit)

Quero implementar um Painel da Brigada de IncÃªndio sem login, restrito Ã  intranet por IP allowlist e exigindo um cabeÃ§alho X-Panel-Key lido de variÃ¡vel de ambiente.
NÃ£o execute nada sem minha autorizaÃ§Ã£o.
Siga etapas M1 â†’ M10, mostrando o plano, os arquivos/diffs e perguntando â€œPosso aplicar?â€ antes de qualquer mudanÃ§a.
Use o padrÃ£o do meu projeto:

Stack: PHP 8 + PostgreSQL + AdminLTE 3 + Bootstrap 4.6

Arquitetura: Controllers em src/controllers/ (sem namespaces), rotas em public/router.php, views em views/, JS pÃºblico em public/assets/js/, RBAC via AuthorizationService (nÃ£o serÃ¡ usado aqui, pois serÃ¡ sem login).

Tabelas:

brigadistas(id, professional_id, start_date, end_date, active, notes, created_at, updated_at) (FK â†’ profissionais_renner(id))

profissionais_renner(id, nome, cpf, setor, ...)

registro_acesso(..., profissional_renner_id, tipo, entrada_at/retorno, saida_final, ...)

LGPD: nÃ£o exibir CPF no painel, apenas nome e setor.

Fuso: America/Sao_Paulo.

Objetivo

Expor uma tela /painel/brigada que lista brigadistas presentes na planta em tempo real, atualizando a cada ~10s.
â€œPresenteâ€ = brigadista ativo (vigÃªncia vÃ¡lida) E com registro de acesso aberto (saida_final IS NULL).
Se a portaria registrar saÃ­da final, a pessoa some do painel no prÃ³ximo refresh.

SeguranÃ§a (sem login)

IP allowlist (ex.: 10.3.0.0/16, 127.0.0.1/32).

CabeÃ§alho X-Panel-Key obrigatÃ³rio; valor vem de variÃ¡vel de ambiente PANEL_BRG_KEY.

NÃ£o expor o segredo no front-end.

Dev mode opcional: se PANEL_BRG_DEV_MODE=1 e IP for 127.0.0.1, permitir acesso sem header somente para desenvolvimento.

Endpoints a criar

GET /painel/brigada â†’ view fullscreen (TV), fonte grande, badge ğŸ§¯, sem CPF.

GET /api/brigada/presentes â†’ JSON com nome, setor, desde (ISO) e professional_id. Sem cache (Cache-Control: no-store).

Consulta base (conceito)

Filtrar:

b.active = TRUE (normalizar true/â€˜tâ€™/â€˜1â€™/1 se necessÃ¡rio)

b.start_date <= CURRENT_DATE

b.end_date IS NULL OR b.end_date >= CURRENT_DATE

r.tipo = 'profissional_renner'

r.saida_final IS NULL
Ordenar por desde (ex.: COALESCE(r.retorno, r.entrada_at)).

Requisitos de implementaÃ§Ã£o

Helpers em public/router.php: getClientIp(), ipInCidr(), ipAllowed(), requirePanelAuth() com allowlist + verificaÃ§Ã£o de X-Panel-Key (de env) e Cache-Control: no-store. Incluir dev mode conforme descrito.

Controller novo: src/controllers/PanelBrigadaController.php com mÃ©todos painel() e presentesApi().

View nova: views/painel/brigada.php (AdminLTE, grid de cards, polling 10s via fetch('/api/brigada/presentes', {cache:'no-store'})). NÃ£o enviar segredo no JS.

Nomes/colunas: Se houver divergÃªncias (entrada_at vs entrada), me mostre a leitura das colunas detectadas e pergunte qual usar.

Ãndices: sugerir e (opcional) gerar SQL para brigadistas(professional_id, active) e registro_acesso(profissional_renner_id) WHERE saida_final IS NULL.

Timezone: formatar â€œdesdeâ€ no back em ISO; a view pode exibir HH:MM em PT-BR.

ResiliÃªncia: se fetch falhar, mostrar aviso â€œReconectandoâ€¦â€ e tentar novamente. Recarregar a pÃ¡gina 1x por dia.

ETAPAS (PERGUNTE ANTES DE EXECUTAR CADA UMA)

M1 â€” Descoberta/validaÃ§Ã£o

Detecte se existem os diretÃ³rios/arquivos: public/router.php, src/controllers/, views/.

Verifique as tabelas e as colunas-chave (brigadistas, profissionais_renner, registro_acesso).

SaÃ­da: relatÃ³rio do que encontrou + eventuais dÃºvidas.

Pergunte: â€œPosso seguir para M2?â€

M2 â€” Plano detalhado

Liste exatamente quais arquivos serÃ£o criados/editados e mostre o plano de diffs.

Pergunte: â€œPosso gerar os rascunhos (sem aplicar)?â€

M3 â€” Rascunhos (sem aplicar)

Gere arquivos rascunho em feature_painel_brigada/drafts/:

router_helpers.php (helpers + dev mode),

routes_snippet.php (rotas /painel/brigada e /api/brigada/presentes),

PanelBrigadaController.php,

views_painel_brigada.php (view),

indices.sql (sugestÃµes de Ã­ndices, sem executar).

Mostre o conteÃºdo (code blocks) e pergunte: â€œPosso aplicar as mudanÃ§as nos arquivos reais?â€

M4 â€” AplicaÃ§Ã£o dos patches

Aplique os helpers e rotas em public/router.php via patch unified diff.

Crie src/controllers/PanelBrigadaController.php e views/painel/brigada.php.

NÃ£o alterar outras rotas/mÃ³dulos.

Pergunte: â€œPosso prosseguir para testes (M5)?â€

M5 â€” Testes locais

Testes curl (sem header â†’ 403; com header correto â†’ 200 JSON).

Teste GET /painel/brigada (HTML).

Mostrar comandos e aguardar minha confirmaÃ§Ã£o antes de rodar qualquer teste automatizado.

M6 â€” Ajustes de colunas

Se a consulta falhar por nome de coluna (ex.: entrada_at vs entrada), sugerir ajuste e perguntar antes de alterar.

M7 â€” OtimizaÃ§Ãµes

Sugerir aplicaÃ§Ã£o de indices.sql. Perguntar antes de executar.

Confirmar Cache-Control: no-store na API e ausÃªncia de CPF na view.

M8 â€” Observabilidade

Adicionar logs leves de erro no controller (try/catch) e no front (marcar status â€œOnline/Reconectandoâ€¦â€).

Perguntar antes de aplicar.

M9 â€” DocumentaÃ§Ã£o

Gerar docs/painel_brigada.md com: variÃ¡veis de ambiente (PANEL_BRG_KEY, PANEL_BRG_DEV_MODE), allowlist, endpoints, testes curl, e instruÃ§Ãµes para injeÃ§Ã£o do header pelo Apache (opcional em produÃ§Ã£o).

Perguntar antes de criar o arquivo.

M10 â€” Rollback

Gerar revert_painel_brigada.patch que remove as mudanÃ§as de router.php e apaga os arquivos criados.

Perguntar antes de gerar.

CritÃ©rios de Aceite (checklist)

 /api/brigada/presentes sÃ³ responde 200 se IP estiver na allowlist e X-Panel-Key correto (ou dev mode permitido).

 JSON sem CPF, com nome, setor, professional_id, desde (ISO).

 /painel/brigada exibe cards com Nome, Setor, badge ğŸ§¯ e â€œdesde HH:MMâ€.

 AtualizaÃ§Ã£o automÃ¡tica a cada ~10s, sem travar; pÃ¡gina recarrega 1x/dia.

 Cache-Control: no-store na API.

 Ãndices sugeridos criados (se aprovado).

 CÃ³digo aplicado apenas apÃ³s minhas aprovaÃ§Ãµes em cada etapa.

Importante: Sempre pergunte antes de escrever/alterar qualquer arquivo ou executar SQL.
Nas saÃ­das, traga patches em diff unificado para eu revisar.
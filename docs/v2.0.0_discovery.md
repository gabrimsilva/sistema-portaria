# ğŸ“‹ DESCOBERTA - VERSÃƒO 2.0.0
**Sistema de Controle de Acesso - Portaria**

**Data:** 14 de outubro de 2025  
**Fase:** M1 - Descoberta & Plano Detalhado  
**Status:** âœ… ConcluÃ­do - Aguardando aprovaÃ§Ã£o para M2

---

## ğŸ¯ OBJETIVOS DA VERSÃƒO 2.0.0

### Problemas CrÃ­ticos a Resolver
1. **Documentos Estrangeiros** - Sistema nÃ£o suporta Passaportes e outros documentos internacionais
2. **Bug de SaÃ­das** - Prestadores de serviÃ§o com saÃ­das nÃ£o registradas corretamente
3. **Entradas Retroativas** - Profissionais Renner sem forma de registrar entradas esquecidas
4. **Validade de Cadastro** - Visitantes/Prestadores sem perÃ­odo de validade para reentradas
5. **Filtros Limitados** - Busca por documentos e placas muito bÃ¡sica
6. **Lista de Ramais** - Consulta rÃ¡pida nÃ£o disponÃ­vel (parcialmente implementado na Brigada)

---

## ğŸ“Š ESTRUTURA ATUAL DO BANCO DE DADOS

### Tabelas Principais Identificadas

#### 1. **visitantes**
```sql
Colunas principais:
- id (integer, PK)
- nome (varchar 100, NOT NULL)
- cpf (varchar 20) âš ï¸ APENAS CPF/RG
- empresa (varchar 100)
- pessoa_visitada (varchar 100)
- placa_veiculo (varchar 20)
- status (varchar 20, default 'ativo')
- data_cadastro (timestamp)
- data_vencimento (timestamp) âœ… JÃ EXISTE!
- foto, email, telefone, qr_code
```

**Achados:**
- âœ… Campo `data_vencimento` jÃ¡ existe!
- âš ï¸ Campo `cpf` aceita atÃ© 20 chars mas nÃ£o suporta tipos de documento
- âš ï¸ Sem campo para paÃ­s/nacionalidade

#### 2. **prestadores_servico**
```sql
Colunas principais:
- id (integer, PK)
- nome (varchar 255, NOT NULL)
- cpf (varchar 14) âš ï¸ APENAS CPF
- empresa (varchar 255)
- setor (varchar 255)
- funcionario_responsavel (varchar 255)
- placa_veiculo (varchar 20)
- observacao (text)
- entrada (timestamp)
- saida (timestamp) âš ï¸ PROBLEMA DE INTEGRIDADE
- deleted_at, deletion_reason, anonymized_at (LGPD)
```

**Achados:**
- âš ï¸ Bug identificado: saÃ­das nÃ£o fecham corretamente nos relatÃ³rios
- âš ï¸ Campo `cpf` limitado a 14 chars
- âœ… Campos de LGPD jÃ¡ implementados
- âš ï¸ Campo `placa_veiculo` em tabela principal (deveria estar em `registro_acesso`)

#### 3. **profissionais_renner**
```sql
Colunas principais:
- id (integer, PK)
- nome (varchar 255, NOT NULL)
- cpf (varchar 11) âš ï¸ APENAS CPF
- setor (varchar 255)
- empresa (varchar 255)
- placa_veiculo (varchar 8)
- data_entrada (timestamp)
- saida, retorno, saida_final (timestamps)
- fre (varchar 50)
- data_admissao (date)
- foto_url (varchar 255)
```

**Achados:**
- âš ï¸ Sem suporte para entrada retroativa
- âš ï¸ MÃºltiplos campos de timestamp (saida, retorno, saida_final) - complexo
- âœ… Campo `foto_url` jÃ¡ existe

#### 4. **registro_acesso** (Tabela Unificada)
```sql
Colunas principais:
- id (integer, PK)
- tipo (varchar 20) - 'profissional', 'visitante', 'prestador'
- nome (varchar 100)
- cpf (varchar 11)
- empresa, setor (varchar 100)
- placa_veiculo (varchar 10)
- funcionario_responsavel (varchar 100)
- observacao (text)
- entrada_at (timestamp, NOT NULL)
- saida_at (timestamp)
- profissional_renner_id (FK para profissionais_renner)
- retorno, saida_final (timestamps)
- created_by, updated_by (FK para usuarios)
```

**RelaÃ§Ãµes:**
- FK: `profissional_renner_id` â†’ `profissionais_renner.id`
- FK: `created_by`, `updated_by` â†’ `usuarios.id`

**Achados:**
- âœ… Tabela unificada bem estruturada
- âš ï¸ Campo `cpf` limitado a 11 chars
- âš ï¸ InconsistÃªncia de tamanhos entre tabelas (cpf: 11/14/20)

#### 5. **audit_log** (Sistema de Auditoria)
```sql
Colunas:
- id (integer, PK)
- user_id (integer)
- acao (varchar) - create/update/delete
- entidade (varchar) - nome da tabela/mÃ³dulo
- entidade_id (integer)
- dados_antes (jsonb)
- dados_depois (jsonb)
- ip_address (varchar)
- user_agent (text)
- timestamp (timestamptz, UTC)
- severidade (varchar, default 'INFO')
- modulo (varchar, default 'sistema')
- resultado (varchar, default 'success')
```

**Achados:**
- âœ… Sistema de auditoria robusto jÃ¡ implementado!
- âœ… Suporta dados antes/depois em JSONB
- âœ… Campos de severidade, mÃ³dulo e resultado jÃ¡ existem
- âœ… Timestamp em UTC com timezone

#### 6. **brigadistas** (Brigada de IncÃªndio)
```sql
Colunas principais:
- id, professional_id
- active, note
- ramal (varchar) âœ… IMPLEMENTADO RECENTEMENTE
```

**Achados:**
- âœ… Sistema de ramais jÃ¡ implementado para brigadistas!
- â„¹ï¸ Pode ser expandido para todos os profissionais

### Outras Tabelas Relevantes
- `usuarios` - UsuÃ¡rios do sistema
- `permissions`, `roles`, `role_permissions` - RBAC
- `auth_policies` - PolÃ­ticas de autenticaÃ§Ã£o
- `sites`, `sectors`, `business_hours`, `holidays` - ConfiguraÃ§Ãµes
- `lgpd_requests` - SolicitaÃ§Ãµes LGPD

---

## ğŸ›£ï¸ MAPEAMENTO DE ROTAS E CONTROLLERS

### Sistema de Roteamento
**Arquivo:** `public/index.php` (NÃƒO `router.php`!)
**PadrÃ£o:** Switch-case com actions aninhados

### Controllers Identificados

#### 1. **VisitantesNovoController**
- **Base Route:** `/visitantes`
- **Actions:** save_ajax, update_ajax
- **Campos obrigatÃ³rios:** nome, setor, placa_veiculo, CPF
- **ValidaÃ§Ã£o:** CpfValidator com dÃ­gitos verificadores
- **NormalizaÃ§Ã£o:** Placa em maiÃºscula, CPF sem pontuaÃ§Ã£o

#### 2. **PrestadoresServicoController**
- **Base Routes:** `/prestadores-servico`, `/reports/prestadores-servico`
- **Actions:** new, save, save_ajax, update_ajax, edit, update, entrada, saida, get_data, delete, edit_inline_ajax, delete_inline_ajax, export
- **Campos obrigatÃ³rios:** nome, setor, funcionario_responsavel, placa_veiculo
- **CPF:** Opcional
- **Export CSV:** âœ… Implementado com sanitizaÃ§Ã£o contra CSV Injection
- **Bug Identificado:** SaÃ­das nÃ£o aparecem corretamente nos relatÃ³rios

#### 3. **ProfissionaisRennerController**
- **Base Routes:** `/profissionais-renner`, `/reports/profissionais-renner`
- **Actions:** save_ajax, update_ajax, get_data, search, edit_inline_ajax, delete_inline_ajax, export
- **Campos:** nome, cpf, setor, empresa, placa_veiculo, fre, data_admissao
- **Sem suporte:** Entrada retroativa âŒ

#### 4. **RegistroAcessoController**
- Registros unificados de acesso
- IntegraÃ§Ã£o com todas as entidades

#### 5. **BrigadaController**
- **Base Route:** `/brigada`
- **Actions:** add, remove, update, upload-foto
- **Campos:** professional_id, ramal, note
- **Ramais:** âœ… Implementado!

### Rotas de RelatÃ³rios Identificadas
```
/reports/profissionais-renner  â†’ ProfissionaisRennerController
/reports/visitantes           â†’ VisitantesNovoController  
/reports/prestadores-servico  â†’ PrestadoresServicoController
```

Todas com export CSV e ediÃ§Ã£o inline!

---

## ğŸ” FILTROS E BUSCAS ATUAIS

### Filtros Existentes
1. **Por Data:** data_inicial, data_final
2. **Por Setor:** Dropdown de setores
3. **Por Placa:** Campo de texto
4. **Por CPF:** Busca parcial (sem tipo de documento)

### LimitaÃ§Ãµes Identificadas
- âŒ Sem filtro por tipo de documento
- âŒ Sem filtro por paÃ­s/nacionalidade
- âŒ Sem busca avanÃ§ada por mÃºltiplos critÃ©rios
- âŒ Sem filtro por status de validade

---

## ğŸ“Š ANÃLISE DE RELATÃ“RIOS - PRESTADORES DE SERVIÃ‡O

### Bug CrÃ­tico Identificado

**Problema:** SaÃ­das nÃ£o registram corretamente nos relatÃ³rios

**Query Atual (PrestadoresServicoController::export):**
```sql
SELECT 
    id, nome, setor, placa_veiculo, empresa, 
    funcionario_responsavel, cpf, entrada, saida
FROM prestadores_servico 
WHERE entrada IS NOT NULL
[filtros...]
ORDER BY entrada DESC
```

**Problemas:**
1. âš ï¸ Campo `saida` pode estar NULL mesmo com acesso finalizado
2. âš ï¸ NÃ£o verifica `registro_acesso.saida_at`
3. âš ï¸ Pode mostrar placas antigas/incorretas
4. âš ï¸ Sem JOIN com `registro_acesso` para dados atualizados

**Impacto:**
- RelatÃ³rios mostram acessos "em aberto" que jÃ¡ foram fechados
- Placas podem estar desatualizadas
- Dados inconsistentes entre `prestadores_servico` e `registro_acesso`

### CorreÃ§Ã£o Proposta
- JOIN com `registro_acesso` para pegar saÃ­da correta
- Ãndice em `(entrada, saida)` para performance
- Trigger para manter consistÃªncia entre tabelas

---

## ğŸ” SISTEMA DE SEGURANÃ‡A E LGPD ATUAL

### Implementado âœ…
1. **MÃ¡scaras de CPF:** 
   - Sistema verifica permissÃ£o `person.cpf.view_unmasked`
   - CPF mascarado por padrÃ£o nos relatÃ³rios
   
2. **Auditoria Completa:**
   - Tabela `audit_log` com before/after
   - Campos: severidade, mÃ³dulo, resultado
   - Timestamp em UTC
   
3. **LGPD:**
   - Campos `deleted_at`, `deletion_reason`, `anonymized_at`
   - Tabela `lgpd_requests` para solicitaÃ§Ãµes

4. **RBAC:**
   - PermissÃµes granulares (ex: `relatorios.excluir_linha`)
   - AuthorizationService centralizado

5. **ValidaÃ§Ãµes:**
   - CpfValidator com dÃ­gitos verificadores
   - DateTimeValidator para timestamps
   - DuplicityValidationService para CPF/Placa em aberto
   - CSRF Protection em todos os forms

### NecessÃ¡rio para V2.0.0
- âš ï¸ PermissÃ£o especÃ­fica para entrada retroativa (`acesso.retroativo`)
- âš ï¸ Auditoria obrigatÃ³ria com motivo para retroativos
- âš ï¸ ValidaÃ§Ã£o de documentos estrangeiros
- âš ï¸ MÃ¡scaras para documentos internacionais

---

## ğŸ“ SERVIÃ‡OS EXISTENTES

### Services Identificados
```
src/services/
â”œâ”€â”€ AuthorizationService.php âœ… RBAC
â”œâ”€â”€ AuditService.php âœ… Auditoria
â”œâ”€â”€ CpfValidator.php âœ… ValidaÃ§Ã£o CPF
â”œâ”€â”€ DateTimeValidator.php âœ… ValidaÃ§Ã£o timestamps
â”œâ”€â”€ DuplicityValidationService.php âœ… Unicidade CPF/Placa
â”œâ”€â”€ FormService.php âœ… Componentes de formulÃ¡rio
â”œâ”€â”€ NavigationService.php âœ… Menu lateral
â”œâ”€â”€ LayoutService.php âœ… Layout AdminLTE
â””â”€â”€ ComponentService.php âœ… Componentes reutilizÃ¡veis
```

### Services NecessÃ¡rios para V2.0.0
- ğŸ“ `DocumentValidator.php` - Validar Passaporte, RG estrangeiro, etc
- ğŸ“ `CountryService.php` - CÃ³digos ISO-3166 de paÃ­ses
- ğŸ“ `ValidityService.php` - Gerenciar validade de cadastros
- ğŸ“ `RamalService.php` - Expandir sistema de ramais

---

## ğŸš¨ PROBLEMAS CRÃTICOS IDENTIFICADOS

### 1. **InconsistÃªncia de Tamanhos de Campo CPF**
```
visitantes.cpf          â†’ varchar(20)
prestadores_servico.cpf â†’ varchar(14)
profissionais_renner.cpf â†’ varchar(11)
registro_acesso.cpf     â†’ varchar(11)
```
**SoluÃ§Ã£o:** Unificar para varchar(50) para suportar documentos internacionais

### 2. **Bug de SaÃ­da - Prestadores**
- SaÃ­das nÃ£o fecham corretamente
- Placas podem ficar "presas" como ativas
- RelatÃ³rios mostram dados inconsistentes

**SoluÃ§Ã£o:** 
- Corrigir JOIN nos relatÃ³rios
- Adicionar Ã­ndices
- Trigger de consistÃªncia

### 3. **Sem Suporte a Documentos Estrangeiros**
- Apenas CPF/RG aceitos
- Sem campo para tipo de documento
- Sem campo para paÃ­s emissor

**SoluÃ§Ã£o:**
- Adicionar `doc_type` (CPF, RG, PASSAPORTE, CNH, RNE)
- Adicionar `doc_country` (ISO-3166 alpha-2)
- Renomear `cpf` para `doc_number`

### 4. **Sem Entrada Retroativa**
- Profissionais Renner nÃ£o podem registrar entradas esquecidas
- Sem auditoria de motivo
- Complexidade de validaÃ§Ã£o com saÃ­das intermediÃ¡rias

**SoluÃ§Ã£o:**
- Endpoint `/api/profissionais/entrada-retroativa`
- Campo obrigatÃ³rio `motivo`
- PermissÃ£o `acesso.retroativo`
- ValidaÃ§Ã£o de integridade com saÃ­das

---

## ğŸ“ˆ IMPACTO POR MÃ“DULO

### Alto Impacto ğŸ”´
1. **Prestadores de ServiÃ§o**
   - Bug de saÃ­da (crÃ­tico)
   - Documentos estrangeiros
   - Validade de cadastro
   - Filtros avanÃ§ados

2. **Visitantes**
   - Documentos estrangeiros
   - Validade jÃ¡ existe (precisa UI)
   - Filtros avanÃ§ados

3. **Profissionais Renner**
   - Entrada retroativa (nova feature)
   - Documentos estrangeiros
   - Expandir ramais

### MÃ©dio Impacto ğŸŸ¡
4. **RelatÃ³rios**
   - CorreÃ§Ã£o de queries
   - Novos filtros
   - Export com novos campos

5. **Registro Acesso**
   - Novos campos
   - ValidaÃ§Ãµes expandidas

### Baixo Impacto ğŸŸ¢
6. **Brigada**
   - JÃ¡ tem ramais (expandir)

7. **Config/Admin**
   - Nova permissÃ£o para retroativo
   - ConfiguraÃ§Ãµes de validade

---

## ğŸ“‹ CRONOGRAMA PROPOSTO M2â†’M12

### âœ… M1 - Descoberta (CONCLUÃDO)
**DuraÃ§Ã£o:** 1 dia  
**Entregas:** Este documento

---

### ğŸ“ M2 - Modelagem & Migrations (Draft)
**DuraÃ§Ã£o:** 2-3 dias  
**Entregas:**
- `001_docs_estrangeiros.sql` - Adicionar doc_type, doc_number, doc_country
- `002_validade_cadastros.sql` - valid_from, valid_until, status
- `003_fix_saida_placas.sql` - Ãndices e triggers de consistÃªncia
- `004_auditoria_retroativa.sql` - Campos adicionais se necessÃ¡rio

**Impacto:** Todas as tabelas de pessoas (visitantes, prestadores, profissionais, registro_acesso)

---

### ğŸ”Œ M3 - Endpoints & Rotas (Draft)
**DuraÃ§Ã£o:** 3-4 dias  
**Entregas:**
- Diff de `public/index.php` com novas rotas
- Controllers em draft:
  - `DocumentoController.php` - CRUD documentos internacionais
  - `EntradaRetroativaController.php` - Entrada retroativa
  - `RamalController.php` - Lista de ramais expandida
  - `ValidadeController.php` - GestÃ£o de validades

**Rotas Propostas:**
```
/api/documentos/validate           â†’ ValidarDocumentoController
/api/profissionais/entrada-retroativa â†’ EntradaRetroativaController
/api/ramais                        â†’ RamalController
/api/cadastros/validade            â†’ ValidadeController
```

---

### ğŸ¨ M4 - Views & JS (Draft)
**DuraÃ§Ã£o:** 4-5 dias  
**Entregas:**
- Forms com seletor de tipo de documento
- Modal de entrada retroativa
- PÃ¡gina de ramais
- Indicadores de validade (expirado/ativo)
- Filtros avanÃ§ados em todos os relatÃ³rios

**Arquivos:**
```
views/
â”œâ”€â”€ documentos/
â”‚   â””â”€â”€ form_internacional.php
â”œâ”€â”€ profissionais_renner/
â”‚   â””â”€â”€ modal_retroativa.php
â”œâ”€â”€ ramais/
â”‚   â””â”€â”€ index.php
â””â”€â”€ components/
    â”œâ”€â”€ validade_badge.php
    â””â”€â”€ filtros_avancados.php

public/assets/js/
â”œâ”€â”€ documento-validator.js
â”œâ”€â”€ entrada-retroativa.js
â”œâ”€â”€ ramais-search.js
â””â”€â”€ filtros-avancados.js
```

---

### ğŸ› M5 - CorreÃ§Ã£o de RelatÃ³rios (Draft)
**DuraÃ§Ã£o:** 2 dias  
**Entregas:**
- `relatorios_fix.md` - DocumentaÃ§Ã£o do problema
- `relatorios_fix.sql` - CorreÃ§Ãµes de queries
- Testes de consistÃªncia

**Foco:** Prestadores de serviÃ§o (bug crÃ­tico)

---

### ğŸ”’ M6 - SeguranÃ§a & LGPD (Checklist)
**DuraÃ§Ã£o:** 2 dias  
**Entregas:**
- `lgpd_checklist_v200.md`
- Ajustes de mÃ¡scaras
- PermissÃµes novas
- Headers de cache

---

### ğŸ§ª M7 - Testes Automatizados (Draft)
**DuraÃ§Ã£o:** 3 dias  
**Entregas:**
```
tests_v200/
â”œâ”€â”€ documentos_internacionais_test.php
â”œâ”€â”€ entrada_retroativa_test.php
â”œâ”€â”€ relatorios_prestadores_test.php
â”œâ”€â”€ validade_cadastros_test.php
â””â”€â”€ curl_collection.json
```

---

### ğŸš€ M8 - AplicaÃ§Ã£o Parcial (Com AprovaÃ§Ã£o)
**DuraÃ§Ã£o:** VariÃ¡vel (depende de aprovaÃ§Ãµes)  
**Entregas:**
- Patches unificados
- AplicaÃ§Ã£o incremental
- Rollback preparado

---

### âœ… M9 - Smoke Tests & ValidaÃ§Ã£o
**DuraÃ§Ã£o:** 1-2 dias  
**Entregas:**
- `smoke_tests_v200.md`
- Checklist de validaÃ§Ã£o manual

---

### ğŸ“Š M10 - Observabilidade & Logs
**DuraÃ§Ã£o:** 1 dia  
**Entregas:**
- Logs de entrada retroativa
- MÃ©tricas de documentos estrangeiros
- Alertas de validade expirada

---

### ğŸ“š M11 - DocumentaÃ§Ã£o do UsuÃ¡rio
**DuraÃ§Ã£o:** 2 dias  
**Entregas:**
- `guia_v200.md`
- Screenshots
- VÃ­deos tutoriais (opcional)

---

### ğŸ”„ M12 - Plano de Rollback
**DuraÃ§Ã£o:** 1 dia  
**Entregas:**
- `rollback_v200.patch`
- Scripts de reversÃ£o
- DocumentaÃ§Ã£o de contingÃªncia

---

## ğŸ“Š RESUMO EXECUTIVO

### Achados Principais
âœ… **Pontos Positivos:**
- Sistema de auditoria robusto jÃ¡ implementado
- LGPD com campos prontos
- Validade de cadastro jÃ¡ existe em visitantes
- Ramais implementados para brigadistas
- Export CSV com sanitizaÃ§Ã£o
- RBAC granular funcionando

âš ï¸ **Problemas CrÃ­ticos:**
1. Bug de saÃ­das em prestadores (ALTA PRIORIDADE)
2. Sem suporte a documentos estrangeiros (MÃ‰DIA PRIORIDADE)
3. Sem entrada retroativa (MÃ‰DIA PRIORIDADE)
4. InconsistÃªncia de tamanhos de campos (BAIXA PRIORIDADE)

### Estimativa de EsforÃ§o
**Total:** 23-30 dias Ãºteis (~1.5 meses)
- M1: âœ… 1 dia (concluÃ­do)
- M2-M7: ~18-25 dias (desenvolvimento)
- M8-M12: ~4-5 dias (deploy e documentaÃ§Ã£o)

### Riscos Identificados
ğŸ”´ **Alto:** MigraÃ§Ã£o de dados existentes para novos campos de documento  
ğŸŸ¡ **MÃ©dio:** Impacto em validaÃ§Ãµes existentes de CPF  
ğŸŸ¢ **Baixo:** Conflitos com features em desenvolvimento

---

## ğŸ¯ PRÃ“XIMOS PASSOS

### DecisÃ£o NecessÃ¡ria
**Posso seguir com M2 (Modelagem & Migrations em Draft)?**

Isso incluirÃ¡:
1. âœï¸ Criar scripts SQL em draft (SEM EXECUTAR)
2. ğŸ“‹ Propor alteraÃ§Ãµes de schema
3. ğŸ” Analisar impacto em dados existentes
4. ğŸ“Š Gerar relatÃ³rio de compatibilidade

**Nenhuma alteraÃ§Ã£o serÃ¡ aplicada sem sua aprovaÃ§Ã£o explÃ­cita!**

---

**Documento gerado em:** 14/10/2025 19:45 (America/Sao_Paulo)  
**Autor:** Sistema de AnÃ¡lise Automatizada  
**VersÃ£o:** 1.0  

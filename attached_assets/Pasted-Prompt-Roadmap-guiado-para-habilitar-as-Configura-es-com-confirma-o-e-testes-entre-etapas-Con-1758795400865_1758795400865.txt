Prompt — Roadmap guiado para habilitar as Configurações (com confirmação e testes entre etapas)

Contexto: Sistema de controle de acesso (entradas/saídas).
Telas envolvidas: Configurações → Organização, Locais/Sites, Permissões (RBAC), Autenticação, Auditoria (iguais aos prints fornecidos).
Stack alvo: Node.js + Express + TypeScript + Prisma (PostgreSQL) + React.
Regras gerais:

NÃO execute nada sem me perguntar. Antes de cada etapa, pergunte: “Posso executar a etapa X? Responda executa para prosseguir ou não para cancelar.”

Ao concluir cada etapa, rode testes automáticos e manuais mínimos e mostre os resultados. Se falhar, pare, relate e proponha correções.

Registre tudo em arquivos markdown dentro do repo (logs de análise, plano, checklist de testes).

FASE A — ANÁLISE (somente leitura, sem alterar arquivos)

Varrer back/front: rotas, controllers, serviços, Prisma schema, componentes/rotas de UI das cinco abas e middlewares (RBAC, autenticação, auditoria).

Verificar o que já está funcional e o que precisa habilitar em cada aba.

Checar validações (CNPJ com DV, tamanhos de campos), upload de logo (limites/tipos), máscara de CPF, índices, logs de auditoria.

Emitir CONFIG_ANALISE_ATUAL.md com tabela OK / FALTA / INCOMPLETO por aba e uma lista de riscos técnicos.

Saída esperada agora (sem executar nada):

Resumo da análise no console + arquivo CONFIG_ANALISE_ATUAL.md.

Em seguida, pergunte: “Posso gerar o plano detalhado (FASE B)? (executa / não)”

FASE B — PLANO DETALHADO (sem aplicar mudanças)

Monte backlog por etapas, cada etapa pequena, com Critérios de Aceite, Testes e Estimativa. Salve como CONFIG_PLANO_ETAPAS.md.

Proponha estas etapas mínimas (ajuste aos achados da análise):

ETAPA 1 — Organização

Back: GET/PUT /config/organization (nome, CNPJ com DV, fuso, idioma, logo com validação: PNG/JPG, ≤2MB).

Front: salvar e carregar, preview do logo, mensagens de sucesso/erro.

Testes: unit (CNPJ DV), integração (PUT/GET), E2E mínimo (preencher, salvar, recarregar).

Eficiência: resposta < 250 ms em GET/PUT local; upload aceito/rejeitado corretamente.

ETAPA 2 — Locais/Sites

Back: CRUD sites e sectors, capacidade ≥ 0; índices; horários de funcionamento (business_hours) e exceções + holidays.

Front: lista, “Novo Local”, edição, cadastro de setores, horários, feriados/exceções.

Testes: CRUD completo + validações.

Eficiência: listagem < 300 ms com paginação; sem N+1.

ETAPA 3 — Permissões (RBAC)

Back: GET/PUT /config/rbac (roles: Admin, Segurança, Recepção, RH) + permissions + role_permissions.

Regra: Admin mantém config.* e person.cpf.view_unmasked.

Front: matriz com checkboxes, “Ver usuários por perfil”, salvar alterações.

Testes: negar/permitir rotas conforme perfil; máscara de CPF obedecida.

Eficiência: atualização de matriz < 250 ms; cache/local state isolado.

ETAPA 4 — Autenticação

Back: GET/PUT /config/auth-policies (senha mínima, expiração em dias, tempo de sessão (min), toggles 2FA e SSO placeholders).

Front: formulário com validação; salvar e refletir.

Testes: unit (validação de políticas); integração (persistência).

Eficiência: GET/PUT < 250 ms.

ETAPA 5 — Auditoria

Back: GET /config/audit?user&entity&action&de&ate&page&pageSize e GET /config/audit/export.csv.

Front: filtros, paginação, botão Exportar CSV.

Testes: gerar log ao alterar qualquer aba; filtro por período; export retorna CSV válido.

Eficiência: consulta filtrada < 300 ms com índices.

ETAPA 6 — Higiene e Navegação

Cancelar requests ao trocar de aba (AbortController), limpar timers/debounces, fechar modais; estados isolados por rota/chaves de cache.

Testes: navegar rápido entre abas sem “sujeira” (sem erros/duplicidade de fetch).

ETAPA 7 — Segurança extra

Sanitização/escape em campos de configuração; limitar tipo/size do upload; rate-limit nos endpoints de config; auditoria das mudanças.

Para cada etapa, inclua no plano:

Arquivos a alterar/criar (com diffs propostos em blocos ```diff).

Migrações Prisma/SQL necessárias (blocos ```sql).

Comandos que pretende rodar (prisma migrate, npm run test, etc.).

Critérios de Aceite e Check de Eficiência.

Saída esperada da Fase B (sem aplicar):

Impressão do resumo + CONFIG_PLANO_ETAPAS.md.

Pergunte: “Posso executar a ETAPA 1 (Organização)? (executa / não)”

FASE C — EXECUÇÃO GUIADA (uma etapa por vez, SEMPRE perguntando antes)

Para cada etapa do plano:

Pergunte: “Posso executar a ETAPA X? (executa / não)”.

Se executa:

Criar branch feat/config-etapa-X-<nome>.

Aplicar os diffs propostos (back e front).

Rodar migrações (se houver) e testes automáticos (unit + integração).

Rodar testes funcionais rápidos (script simples com supertest/playwright ou requests cURL) e um micro teste de performance local (ex.: autocannon 10s / 50 conexões) nos endpoints alterados.

Gerar relatório ETAPA_X_RESULTADOS.md com: o que mudou, comandos rodados, testes e métricas de latência (p50/p95).

Mostrar resumo de arquivos alterados.

Se algo falhar, parar e propor correção.

Se não: pular etapa e aguardar instruções.

Importante: após concluir e validar a etapa X, pergunte: “Posso prosseguir para a ETAPA X+1? (executa / não)”.

Critérios de Aceite Gerais

Cada aba funciona de ponta a ponta conforme campos exibidos nos prints.

Validações de negócio ativas (CNPJ com DV; tamanhos; upload logo 2MB PNG/JPG).

RBAC respeitado (Admin total; Recepção sem acesso de escrita; máscara de CPF via permissão).

Auditoria registra quem/quando/antes/depois/IP ao alterar qualquer configuração; Exportar CSV funciona.

Eficiência mínima atendida nos endpoints (p50 < 250–300 ms em ambiente local).

Higiene de estado: sem “sujeira” entre abas, sem requests pendentes.

Formato de resposta esperado AGORA

Relatório de análise: CONFIG_ANALISE_ATUAL.md (sem executar nada).

Pergunta: “Posso gerar o plano detalhado (FASE B)? (executa / não)”

Reforce durante todo o processo: não executar nada sem minha confirmação por etapa.
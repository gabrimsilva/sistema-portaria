#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Planner/Generator interativo da funcionalidade BRIGADA (Controle de Portaria)
- N√ÉO executa nada sem permiss√£o
- Gera rascunhos em feature_brigada/ e s√≥ aplica no projeto ap√≥s confirma√ß√£o
- Assumindo stack PHP + AdminLTE 3 + Bootstrap 4.6 + PostgreSQL

Autor: Gabis + ChatGPT
"""

import os
import sys
import shutil
from textwrap import dedent

# ==========
# CONFIG PADR√ÉO (voc√™ pode mudar em tempo de execu√ß√£o)
# ==========
DEFAULTS = {
    "app_root": "./",  # raiz do projeto
    "routes_file": "routes/web.php",   # arquivo de rotas PHP (ajuste se usar outro)
    "controllers_dir": "app/Controllers",
    "models_dir": "app/Models",
    "views_dir": "views",  # ex.: views/brigada/index.php
    "public_menu_file": "views/layouts/partials/sidebar.php",  # onde fica o menu lateral
    "db_name": "controle-portaria-db",
    "db_schema": "public",
    "professionals_table": "professionals",  # tabela j√° importada dos profissionais
    "rbac_guard": "Admin,Seguran√ßa"  # perfis com acesso (ajuste se necess√°rio)
}

BANNER = r"""
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
           PLANEJADOR ‚Äî M√ìDULO "BRIGADA"
"""

PLAN = [
    ("M1", "Confirmar estrutura do projeto e caminhos (controllers, models, views, rotas, menu)."),
    ("M2", "Gerar MIGRATION SQL: tabela brigadistas (FK para professionals, unique por profissional)."),
    ("M3", "Gerar BACKEND: Model Brigadista, Controller BrigadaController, Reposit√≥rio simples."),
    ("M4", "Gerar ROTAS: GET /brigada (lista), POST /brigada/add, POST /brigada/remove, GET /api/professionals/search."),
    ("M5", "Gerar VIEW: p√°gina BRIGADA (busca profissional ‚Üí incluir; lista de brigadistas)."),
    ("M6", "Inserir ITEM DE MENU ‚ÄúBRIGADA‚Äù (RBAC: Admin/Seguran√ßa) ‚Äî opcional, controlado por confirma√ß√£o."),
    ("M7", "Checklist de permiss√µes e testes (endpoints, csrf, RBAC)."),
    ("M8", "Orienta√ß√µes de deploy: aplicar SQL, limpar cache, reiniciar servi√ßo web, smoke tests."),
]

# ===== Helpers =====

def ask_yes_no(prompt) -> bool:
    while True:
        ans = input(f"{prompt} [s/N]: ").strip().lower()
        if ans in ("s", "sim", "y", "yes"):
            return True
        if ans in ("n", "nao", "n√£o", "no", ""):
            return False

def ensure_dir(path):
    os.makedirs(path, exist_ok=True)

def write_file(path, content, overwrite=False):
    if os.path.exists(path) and not overwrite:
        print(f"‚ö†Ô∏è  Arquivo j√° existe, n√£o sobrescrito: {path}")
        return
    ensure_dir(os.path.dirname(path))
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"‚úÖ Gerado: {path}")

def safe_copy(src, dst):
    ensure_dir(os.path.dirname(dst))
    shutil.copy2(src, dst)
    print(f"‚û°Ô∏è  Copiado: {src}  ‚Üí  {dst}")

def render_sql_migration(cfg):
    schema = cfg["db_schema"]
    professionals = cfg["professionals_table"]
    return dedent(f"""
    -- MIGRATION: CRIAR TABELA brigadistas
    -- Pol√≠tica: um profissional pode estar no m√°ximo uma vez na brigada (unique)
    -- Ajuste nomes/colunas conforme seu schema atual.

    CREATE TABLE IF NOT EXISTS {schema}.brigadistas (
        id             BIGSERIAL PRIMARY KEY,
        professional_id BIGINT NOT NULL UNIQUE,
        active         BOOLEAN NOT NULL DEFAULT TRUE,
        note           TEXT,
        created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
        updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
        CONSTRAINT fk_brigadista_prof FOREIGN KEY (professional_id)
          REFERENCES {schema}.{professionals}(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_brigadistas_active ON {schema}.brigadistas (active);

    -- Trigger simples para updated_at
    CREATE OR REPLACE FUNCTION {schema}.set_updated_at() RETURNS trigger AS $$
    BEGIN
      NEW.updated_at := now();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    DROP TRIGGER IF EXISTS trg_brigadistas_updated_at ON {schema}.brigadistas;
    CREATE TRIGGER trg_brigadistas_updated_at
      BEFORE UPDATE ON {schema}.brigadistas
      FOR EACH ROW EXECUTE FUNCTION {schema}.set_updated_at();
    """).strip() + "\n"

def render_model_brigadista(cfg):
    schema = cfg["db_schema"]
    return dedent(f"""\
    <?php
    // app/Models/Brigadista.php
    // Model simples (PDO) ‚Äî ajuste para seu ORM/arquitetura se necess√°rio.

    namespace App\\Models;

    class Brigadista
    {{
        private $pdo;

        public function __construct($pdo)
        {{
            $this->pdo = $pdo;
        }}

        public function all() {{
            $sql = "SELECT b.id, b.professional_id, b.active, p.name AS professional_name, p.sector
                    FROM {schema}.brigadistas b
                    JOIN {schema}.professionals p ON p.id = b.professional_id
                    ORDER BY p.name ASC";
            return $this->pdo->query($sql)->fetchAll(\\PDO::FETCH_ASSOC);
        }}

        public function searchProfessionals($q) {{
            $sql = "SELECT id, name, sector
                    FROM {schema}.professionals
                    WHERE unaccent(name) ILIKE unaccent(:q)
                    ORDER BY name ASC LIMIT 20";
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute([':q' => "%".$q."%"]);
            return $stmt->fetchAll(\\PDO::FETCH_ASSOC);
        }}

        public function add($professional_id) {{
            $sql = "INSERT INTO {schema}.brigadistas (professional_id) VALUES (:pid)
                    ON CONFLICT (professional_id) DO UPDATE SET active = TRUE, updated_at = now()
                    RETURNING id";
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute([':pid' => $professional_id]);
            return $stmt->fetchColumn();
        }}

        public function remove($id) {{
            $stmt = $this->pdo->prepare("DELETE FROM {schema}.brigadistas WHERE id = :id");
            return $stmt->execute([':id' => $id]);
        }}
    }}
    """).strip() + "\n"

def render_controller_brigada(cfg):
    rbac_guard = cfg["rbac_guard"]
    return dedent(f"""\
    <?php
    // app/Controllers/BrigadaController.php
    // Controller b√°sico BRIGADA (AdminLTE). Ajuste integra√ß√£o com seu container/DI/autenticador.

    namespace App\\Controllers;

    use App\\Models\\Brigadista;

    class BrigadaController
    {{
        private $pdo;
        private $view;
        private $auth;

        public function __construct($pdo, $view, $auth)
        {{
            $this->pdo  = $pdo;
            $this->view = $view;
            $this->auth = $auth;
        }}

        private function guard() {{
            // RBAC simples ‚Äî ajuste para seu middleware real
            $role = $this->auth->currentUserRole();
            $allowed = array_map('trim', explode(',', '{rbac_guard}'));
            if (!in_array($role, $allowed)) {{
                http_response_code(403);
                echo "Acesso negado";
                exit;
            }}
        }}

        public function index() {{
            $this->guard();
            $m = new Brigadista($this->pdo);
            $data = $m->all();
            return $this->view->render('brigada/index.php', ['brigadistas' => $data]);
        }}

        public function apiSearchProfessionals() {{
            $this->guard();
            $q = isset($_GET['q']) ? trim($_GET['q']) : '';
            $m = new Brigadista($this->pdo);
            $rows = $m->searchProfessionals($q);
            header('Content-Type: application/json; charset=utf-8');
            echo json_encode($rows);
        }}

        public function add() {{
            $this->guard();
            // CSRF: ajuste para seu framework
            $pid = intval($_POST['professional_id'] ?? 0);
            if ($pid > 0) {{
                $m = new Brigadista($this->pdo);
                $m->add($pid);
            }}
            header('Location: /brigada');
        }}

        public function remove() {{
            $this->guard();
            // CSRF: ajuste para seu framework
            $id = intval($_POST['id'] ?? 0);
            if ($id > 0) {{
                $m = new Brigadista($this->pdo);
                $m->remove($id);
            }}
            header('Location: /brigada');
        }}
    }}
    """).strip() + "\n"

def render_routes_snippet():
    return dedent("""\
    // ROTAS BRIGADA ‚Äî cole no seu arquivo de rotas (ajuste assinatura conforme seu router)
    $router->get('/brigada', 'BrigadaController@index');                 // listagem + tela
    $router->get('/api/professionals/search', 'BrigadaController@apiSearchProfessionals'); // busca
    $router->post('/brigada/add', 'BrigadaController@add');              // incluir brigadista
    $router->post('/brigada/remove', 'BrigadaController@remove');        // remover brigadista
    """).strip() + "\n"

def render_view_brigada():
    return dedent("""\
    <!-- views/brigada/index.php -->
    <!-- AdminLTE 3 + Bootstrap 4.6. Tela √∫nica: buscar profissional e listar brigadistas -->
    <div class="content-header">
      <div class="container-fluid">
        <h1 class="m-0">Brigada</h1>
        <p class="text-muted">Inclua brigadistas a partir dos profissionais j√° cadastrados e visualize a lista atual.</p>
      </div>
    </div>

    <section class="content">
      <div class="container-fluid">

        <!-- Card: Incluir brigadista -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">Incluir brigadista</h3></div>
          <div class="card-body">
            <div class="form-group">
              <label for="q">Buscar profissional</label>
              <input type="text" id="q" class="form-control" placeholder="Digite nome do profissional..." />
            </div>
            <div id="searchResults" class="list-group mb-3" style="display:none;"></div>

            <form id="formAdd" method="POST" action="/brigada/add" style="display:none;">
              <input type="hidden" name="professional_id" id="professional_id" />
              <button type="submit" class="btn btn-primary">Adicionar √† Brigada</button>
            </form>
          </div>
        </div>

        <!-- Card: Lista Brigadistas -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">Brigadistas</h3></div>
          <div class="card-body p-0">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Profissional</th>
                  <th>Setor</th>
                  <th>Status</th>
                  <th style="width:100px">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <?php foreach (($brigadistas ?? []) as $b): ?>
                <tr>
                  <td><?= htmlspecialchars($b['professional_name']) ?></td>
                  <td><?= htmlspecialchars($b['sector'] ?? '-') ?></td>
                  <td><?= !empty($b['active']) ? 'Ativo' : 'Inativo' ?></td>
                  <td>
                    <form method="POST" action="/brigada/remove" onsubmit="return confirm('Remover brigadista?');">
                      <input type="hidden" name="id" value="<?= (int)$b['id'] ?>">
                      <button class="btn btn-sm btn-danger">Remover</button>
                    </form>
                  </td>
                </tr>
                <?php endforeach; ?>
                <?php if (empty($brigadistas)): ?>
                <tr><td colspan="4" class="text-center text-muted">Nenhum brigadista cadastrado.</td></tr>
                <?php endif; ?>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <script>
// Busca din√¢mica de profissionais
const q = document.getElementById('q');
const results = document.getElementById('searchResults');
const formAdd = document.getElementById('formAdd');
const pidInput = document.getElementById('professional_id');

let debounce;
q.addEventListener('input', () => {
  const term = q.value.trim();
  clearTimeout(debounce);
  if (term.length < 2) { results.style.display='none'; return; }

  debounce = setTimeout(async () => {
    const resp = await fetch('/api/professionals/search?q=' + encodeURIComponent(term));
    const data = await resp.json();
    results.innerHTML = '';
    data.forEach(p => {
      const a = document.createElement('a');
      a.href = '#'; a.className = 'list-group-item list-group-item-action';
      a.textContent = `${p.name} ‚Äî ${p.sector || '-'}`;
      a.onclick = (ev) => {{
        ev.preventDefault();
        pidInput.value = p.id;
        formAdd.style.display = 'block';
        results.style.display = 'none';
        q.value = `${p.name}`;
      }};
      results.appendChild(a);
    });
    results.style.display = data.length ? 'block' : 'none';
  }, 300);
});
    </script>
    """).strip() + "\n"

def render_menu_snippet():
    return dedent("""\
    <!-- ITEM DE MENU "BRIGADA" (insira no sidebar/menu, respeitando seu RBAC/middlewares) -->
    <li class="nav-item">
      <a href="/brigada" class="nav-link">
        <i class="nav-icon fas fa-fire-extinguisher"></i>
        <p>Brigada</p>
      </a>
    </li>
    """).strip() + "\n"

def show_plan():
    print("üìå PLANO DA FUNCIONALIDADE ‚ÄúBRIGADA‚Äù")
    for code, desc in PLAN:
        print(f"  {code} ‚Äî {desc}")
    print()

def collect_paths():
    cfg = DEFAULTS.copy()
    print("üìÅ Caminhos detectados/assumidos:")
    for k, v in cfg.items():
        print(f"  - {k}: {v}")
    print("\nVoc√™ pode manter ou ajustar acima editando DEFAULTS no script, se quiser.")
    return cfg

def main():
    print(BANNER)
    print("Objetivo: BRIGADA > Incluir brigadista a partir de profissionais existentes + listar na mesma tela.\n")
    show_plan()

    cfg = collect_paths()
    ensure_dir("feature_brigada/drafts/migrations")
    ensure_dir("feature_brigada/drafts/controllers")
    ensure_dir("feature_brigada/drafts/models")
    ensure_dir("feature_brigada/drafts/views")
    ensure_dir("feature_brigada/drafts/snippets")

    # M2 ‚Äî Migration SQL
    if ask_yes_no("M2) Gerar rascunho da MIGRATION SQL?"):
        sql = render_sql_migration(cfg)
        write_file("feature_brigada/drafts/migrations/001_create_brigadistas.sql", sql)

    # M3 ‚Äî Backend (Model + Controller)
    if ask_yes_no("M3) Gerar rascunho do BACKEND (Model + Controller)?"):
        write_file("feature_brigada/drafts/models/Brigadista.php", render_model_brigadista(cfg))
        write_file("feature_brigada/drafts/controllers/BrigadaController.php", render_controller_brigada(cfg))

    # M4 ‚Äî Rotas
    if ask_yes_no("M4) Gerar rascunho do SNIPPET de ROTAS?"):
        write_file("feature_brigada/drafts/snippets/routes_brigada.php", render_routes_snippet())

    # M5 ‚Äî View
    if ask_yes_no("M5) Gerar rascunho da VIEW BRIGADA?"):
        write_file("feature_brigada/drafts/views/index.php", render_view_brigada())

    # M6 ‚Äî Menu
    if ask_yes_no("M6) Gerar rascunho do snippet de MENU 'BRIGADA'?"):
        write_file("feature_brigada/drafts/snippets/menu_brigada.html", render_menu_snippet())

    print("\nüß™ M7) Checklist de permiss√µes/testes (apenas instru√ß√µes):")
    print(dedent(f"""
    - Garanta RBAC de acesso √† rota /brigada (perfis: {cfg['rbac_guard']}).
    - Proteja POST /brigada/add e /brigada/remove com CSRF do seu framework.
    - Confirme que h√° √≠ndice/EXTENS√ÉO 'unaccent' no Postgres se quiser busca acentuada:
      CREATE EXTENSION IF NOT EXISTS unaccent;
    - Em produ√ß√£o, defina TIME ZONE e headers conforme LGPD; audite altera√ß√µes (triggers).
    """))

    # M8 ‚Äî Aplica√ß√£o no projeto (c√≥pia dos rascunhos)
    if ask_yes_no("\nM8) Deseja APLICAR os rascunhos ao projeto (copiar para os diret√≥rios de destino)?"):
        # mover arquivos gerados para a estrutura do projeto
        dst_controller = os.path.join(cfg["controllers_dir"], "BrigadaController.php")
        dst_model = os.path.join(cfg["models_dir"], "Brigadista.php")
        dst_view_dir = os.path.join(cfg["views_dir"], "brigada")
        dst_view = os.path.join(dst_view_dir, "index.php")
        ensure_dir(dst_view_dir)

        # Copiar
        safe_copy("feature_brigada/drafts/controllers/BrigadaController.php", dst_controller)
        safe_copy("feature_brigada/drafts/models/Brigadista.php", dst_model)
        safe_copy("feature_brigada/drafts/views/index.php", dst_view)

        print("\nüëâ A√á√ïES MANUAIS RESTANTES (controladas por voc√™):")
        print(f"  1) Adicionar ROTAS em: {cfg['routes_file']} (use feature_brigada/drafts/snippets/routes_brigada.php)")
        print(f"  2) Inserir item de MENU em: {cfg['public_menu_file']} (use feature_brigada/drafts/snippets/menu_brigada.html)")
        print("  3) Aplicar a MIGRATION no banco (psql/pgAdmin):")
        print("     psql -d controle-portaria-db -f feature_brigada/drafts/migrations/001_create_brigadistas.sql")
        print("  4) Limpar cache de views/rotas do framework (se houver) e reiniciar o servi√ßo web.")
        print("  5) Testes: acessar /brigada, buscar profissional, incluir, listar e remover.")

    print("\nüéâ Pronto! Nada foi executado sem consentimento. Os rascunhos est√£o em feature_brigada/.")
    print("Se quiser reexecutar algum passo, rode novamente o script.\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nInterrompido pelo usu√°rio.")
        sys.exit(1)

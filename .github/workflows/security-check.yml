# üõ°Ô∏è CI/CD: Verifica√ß√£o Autom√°tica de Seguran√ßa Biom√©trica
# 
# Este workflow executa automaticamente testes de seguran√ßa
# em cada commit para prevenir regress√µes de vulnerabilidades.

name: üîí Seguran√ßa Biom√©trica

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    name: üîç Scanner de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üêò Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: pdo, pdo_pgsql, gd, curl
        
    - name: üóÑÔ∏è Setup PostgreSQL
      uses: harmon758/postgresql-action@v1
      with:
        postgresql version: '16'
        postgresql db: 'access_control_test'
        postgresql user: 'test_user'
        postgresql password: 'test_password'
        
    - name: üì¶ Install dependencies
      run: |
        composer install --no-dev --optimize-autoloader
        
    - name: ‚öôÔ∏è Setup test environment
      run: |
        export BIOMETRIC_ENCRYPTION_KEY="ci-test-key-$(openssl rand -hex 32)"
        export ENVIRONMENT="development"
        mkdir -p storage/secure/biometrics
        chmod 700 storage/secure/biometrics
        
    - name: üöÄ Start test server with router
      run: |
        php -S localhost:5000 -t public public/router.php &
        sleep 3
        
    - name: üîç Executar scanner de c√≥digo
      run: |
        php tests/security/CodeScannerGuard.php
        
    - name: üõ°Ô∏è Executar testes de seguran√ßa
      run: |
        php tests/run-security-tests.php
        
    - name: üìä Upload resultados
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: security-test-results
        path: tests/results/
        
  vulnerability-check:
    name: üîé Verifica√ß√£o de Vulnerabilidades
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîç Executar verifica√ß√£o de depend√™ncias
      run: |
        # Verificar composer.json para depend√™ncias vulner√°veis
        if [ -f composer.json ]; then
          echo "Verificando depend√™ncias PHP..."
          # Adicionar verifica√ß√µes espec√≠ficas aqui
        fi
        
    - name: üö´ Verificar arquivos sens√≠veis
      run: |
        echo "Verificando arquivos sens√≠veis..."
        
        # Verificar se h√° arquivos de upload no reposit√≥rio
        if find public/uploads -name "*.jpg" -o -name "*.png" -o -name "*.gif" 2>/dev/null | grep -q .; then
          echo "‚ùå ERRO: Arquivos de upload encontrados no reposit√≥rio!"
          exit 1
        fi
        
        # Verificar chaves hardcoded
        if grep -r "BIOMETRIC_ENCRYPTION_KEY.*=" --include="*.php" --exclude-dir=tests .; then
          echo "‚ùå ERRO: Chave de criptografia hardcoded encontrada!"
          exit 1
        fi
        
        echo "‚úÖ Verifica√ß√£o de arquivos sens√≠veis passou"
        
  deploy-readiness:
    name: üöÄ Verifica√ß√£o de Deploy
    runs-on: ubuntu-latest
    needs: [security-scan, vulnerability-check]
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: ‚úÖ Verificar pr√©-requisitos de produ√ß√£o
      run: |
        echo "Verificando pr√©-requisitos para produ√ß√£o..."
        
        # Verificar .htaccess
        if [ ! -f public/.htaccess ]; then
          echo "‚ùå ERRO: .htaccess n√£o encontrado"
          exit 1
        fi
        
        # Verificar se .htaccess bloqueia uploads
        if ! grep -q "uploads/" public/.htaccess; then
          echo "‚ùå ERRO: .htaccess n√£o bloqueia uploads/"
          exit 1
        fi
        
        # Verificar estrutura de seguran√ßa
        if [ ! -d storage/secure ]; then
          echo "‚ùå ERRO: Diret√≥rio de armazenamento seguro n√£o existe"
          exit 1
        fi
        
        echo "‚úÖ Sistema pronto para produ√ß√£o!"